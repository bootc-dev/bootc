name: 'Bootc Ubuntu Setup'
description: 'Default host setup'
inputs:
  libvirt:
    description: 'Install libvirt and virtualization stack'
    required: false
    default: 'false'
runs:
  using: 'composite'
  steps:
    # We really want support for heredocs
    - name: Update podman and install just
      shell: bash
      run: |
        set -eux
        # Require the runner is ubuntu-24.04
        IDV=$(. /usr/lib/os-release && echo ${ID}-${VERSION_ID})
        test "${IDV}" = "ubuntu-24.04"
        # plucky is the next release
        echo 'deb http://azure.archive.ubuntu.com/ubuntu plucky universe main' | sudo tee /etc/apt/sources.list.d/plucky.list
        sudo apt update
        # skopeo is currently older in plucky for some reason hence --allow-downgrades
        sudo apt install -y --allow-downgrades crun/plucky podman/plucky skopeo/plucky just
    # The default runners have TONS of crud on them...
    - name: Free up disk space on runner
      shell: bash
      run: |
        set -xeuo pipefail
        sudo df -h
        unwanted=('^aspnetcore-.*' '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*'
                  azure-cli google-chrome-stable firefox mono-devel)
        for x in ${unwanted[@]}; do
          sudo apt-get remove -y $x
        done
        # Start other removal operations in parallel
        sudo docker image prune --all --force
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android
        sudo df -h
    # This is the default on e.g. Fedora derivatives, but not Debian
    - name: Enable unprivileged /dev/kvm access
      shell: bash
      run: |
        set -xeuo pipefail
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
        ls -l /dev/kvm
    # Used by a few workflows, but generally useful
    - name: Set architecture variable
      id: set_arch
      shell: bash
      run: echo "ARCH=$(arch)" >> $GITHUB_ENV
    # We often use Rust, so set up opinionated default caching
    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        cache-all-crates: true
        # Only generate caches on push to git main
        save-if: ${{ github.ref == 'refs/heads/main' }}
        # Suppress actually using the cache for builds running from
        # git main so that we avoid incremental compilation bugs
        lookup-only: ${{ github.ref == 'refs/heads/main' }}
    # Install libvirt stack if requested
    - name: Install libvirt and virtualization stack
      if: ${{ inputs.libvirt == 'true' }}
      shell: bash
      run: |
        set -xeuo pipefail
        export BCVK_VERSION=0.5.3
        sudo apt install -y libkrb5-dev pkg-config libvirt-dev genisoimage qemu-utils qemu-kvm virtiofsd libvirt-daemon-system
        # Something in the stack is overriding this, but we want session right now for bcvk
        echo LIBVIRT_DEFAULT_URI=qemu:///session >> $GITHUB_ENV
        td=$(mktemp -d)
        cd $td
        # Install bcvk
        target=bcvk-$(arch)-unknown-linux-gnu
        curl -LO https://github.com/bootc-dev/bcvk/releases/download/v${BCVK_VERSION}/${target}.tar.gz
        tar xzf ${target}.tar.gz
        sudo install -T ${target} /usr/bin/bcvk
        cd -
        rm -rf "$td"

        # Also bump the default fd limit as a workaround for https://github.com/bootc-dev/bcvk/issues/65
        sudo sed -i -e 's,^\* hard nofile 65536,* hard nofile 524288,' /etc/security/limits.conf
